manifest {
    author = 'Patrick Blaney'
    homePage = 'https://github.com/pblaney/mgp1000'
    description = 'Myeloma Genome Project 1000 Bioinformatics Nextflow Pipeline'
    name = 'MGP1000'
    nextflowVersion = '>=20.01.0'
}

// Set global default parameters used in config file that will be overwritten with CLI run command
params.email = null
params.run_id = null

notification {
    
    if( "${params.email}" ) {
        enabled = true
        to = "${params.email}"
        from = "${params.email}"
    } else {
        enabled = false
    }
}

report {
    enabled = true
    file = "nextflow_report.${params.run_id}.html"
}

trace {
    enabled = true
    fields = "task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes"
    file = "trace.${params.run_id}.txt"
    raw = true
}

timeline {
    enabled = true
    file = "timeline_report.${params.run_id}.html"
}

// #################################################### \\
// ~~~~~~~~~~~~~~ PROFILE CONFIGURATION ~~~~~~~~~~~~~~~ \\

params.singularity_module = null

profiles {

    // Profile for Preprocessing step of pipeline using Slurm executor
    preprocessing {
        
        singularity.enabled = true
        singularity.autoMounts = true

        // Set the Singularity module if one was provided as input parameter
        if( params.singularity_module ) {
            process.module = "${params.singularity_module}"
        }

        process.executor = 'slurm'

        process {

            errorStrategy = "retry"

            withName: revertMappedBam_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 16.GB * task.attempt } // Max of 32.GB 
                time = { 9.h * task.attempt}      // Max of 18.h
            }
            withName: bamToFastq_biobambam {
                container = "containers/biobambam-2.0.87.simg"
                cpus = 1
                maxRetries = 3
                memory = { 256.MB * task.attempt } // Max of 1.GB
                time = { 8.h * task.attempt }      // Max of 32.h
            }
            withName: fastqTrimming_trimmomatic {
                container = "containers/trimmomatic-0.36.simg"
                cpus = 8
                maxRetries = 3
                memory = { 6.GB * task.attempt } // Max of 24.GB
                time = { 18.h * task.attempt }   // Max of 72.h
            }
            withName: fastqQualityControlMetrics_fastqc {
                container = "containers/fastqc-0.11.9.simg"
                cpus = 1
                maxRetries = 3
                memory = { 512.MB * task.attempt } // Max of 2.GB
                time = { 4.h * task.attempt }      // Max of 16.h
            }
            withName: alignment_bwa {
                container = "containers/bwa-0.7.17-sambamba-0.7.1.simg"
                cpus = 8
                maxRetries = 3
                memory = { 16.GB * task.attempt } // Max of 64.GB
                time = { 36.h * task.attempt }   // Max of 144.h
            }
            withName: fixMateInformationAndSort_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 2
                memory = { 16.GB * task.attempt } // Max of 48.GB
                time = { 18.h * task.attempt }    // Max of 54.h
            }
            withName: markDuplicatesAndIndex_sambamba {
                container = "containers/sambamba-0.7.1.simg"
                cpus = 1
                maxRetries = 3
                memory = { 4.GB * task.attempt } // Max of 16.GB
                time = { 8.h * task.attempt }    // Max of 32.h
            }
            withName: downsampleBam_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 2
                memory = { 16.GB * task.attempt } // Max of 48.GB
                time = { 3.h * task.attempt }     // Max of 9.h
            }
            withName: baseRecalibrator_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 3.h * task.attempt }    // Max of 6.h
            }
            withName: applyBqsr_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 3
                memory = { 1.GB * task.attempt } // Max of 4.GB
                time = { 6.h * task.attempt }    // Max of 24.h
            }
            withName: collectWgsMetrics_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 6.h * task.attempt }    // Max of 12.h
            }
            withName: collectGcBiasMetrics_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 6.h * task.attempt }    // Max of 12.h
            }
            withName: extremeBamQualityControl_qualimap {
                container = "containers/qualimap-2.2.1.simg"
                cpus = 8
                maxRetries = 1
                memory = { 6.GB * task.attempt } // Max of 12.GB
                time = { 6.h * task.attempt }    // Max of 12.h
            }
        }
    }

    // Profile for Germline Variant Analysis step of pipeline using Slurm executor
    germline {

        singularity.enabled = true
        singularity.autoMounts = true

        // Set the Singularity module if one was provided as input parameter
        if( params.singularity_module ) {
            process.module = "${params.singularity_module}"
        }

        process.executor = 'slurm'

        process {

            errorStrategy = "retry"

            withName: telomereLengthEstimation_telseq {
                container = "containers/telseq-0.0.1.simg"
                cpus = 1
                maxRetries = 1
                memory = { 256.MB * task.attempt } // Max of 512.MB
                time = { 4.h * task.attempt }      // Max of 8.h
            }
            withName: splitIntervalList_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                memory = 1.GB
                time = 1.h
            }
            withName: haplotypeCaller_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 3
                memory = { 8.GB * task.attempt } // Max of 32.GB
                time = { 6.h * task.attempt }    // Max of 32.h
            }
            withName: mergeAndSortGvcfs_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 12.GB * task.attempt } // Max of 24.GB
                time = { 4.h * task.attempt }     // Max of 8.h
            }
            withName: combineAllGvcfs_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 8.GB * task.attempt } // Max of 16.GB
                time = { 4.h * task.attempt }    // Max of 8.h
            }
            withName: jointGenotyping_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 4.h * task.attempt }    // Max of 8.h
            }
            withName: excessHeterozygosityHardFilter_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 1.GB * task.attempt } // Max of 2.GB
                time = { 1.h * task.attempt }    // Max of 2.h
            }
            withName: indelVariantRecalibration_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 4.h * task.attempt }    // Max of 8.h
            }
            withName: snpVariantRecalibration_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 4.h * task.attempt }    // Max of 8.h
            }
            withName: applyIndelAndSnpVqsr_gatk {
                container = "containers/gatk-4.1.7.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 1.GB * task.attempt } // Max of 2.GB
                time = { 1.h * task.attempt }    // Max of 2.h
            }
            withName: splitMultiallelicAndLeftNormalizeVcf_bcftools {
                container = "containers/bcftools-1.10.2.simg"
                cpus = 8
                maxRetries = 1
                memory = { 1.GB * task.attempt } // Max of 2.GB
                time = { 2.h * task.attempt }    // Max of 4.h
            }
            withName: downloadVepAnnotationReferences_vep {
                container = "containers/vep-101.0.simg"
                cpus = 1
                memory = 256.MB
                time = 1.h
            }
            withName: annotateGermlineVcf_vep {
                container = "containers/vep-101.0.simg"
                cpus = 1
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 8.h * task.attempt }    // Max of 16.h
            }
            withName: referenceVcfPrep_bcftools {
                container = "containers/bcftools-1.10.2.simg"
                cpus = 8
                memory = 256.MB
                time = 12.h
            }
            withName: mergeCohortAndReferenceVcf_bcftools {
                container = "containers/bcftools-1.10.2.simg"
                cpus = 8
                maxRetries = 1
                memory = { 256.MB * task.attempt } // Max of 512.MB
                time = { 8.h * task.attempt }      // Max of 16.h
            }
            withName: hardFilterCohortReferenceMergedVcf_vcftools {
                container = "containers/vcftools-0.1.16.simg"
                cpus = 1
                maxRetries = 1
                memory = { 256.MB * task.attempt } // Max of 512.MB
                time = { 8.h * task.attempt }      // Max of 16.h
            }
            withName: filterPlinkFilesForAdmixture_plink {
                container = "containers/plink-1.90.simg"
                cpus = 8
                maxRetries = 1
                memory = { 2.GB * task.attempt } // Max of 4.GB
                time = { 2.h * task.attempt }    // Max of 4.h
            }
            withName: ancestryEstimation_admixture {
                container = "containers/admixture-1.3.0.simg"
                cpus = 8
                maxRetries = 1
                memory = { 4.GB * task.attempt } // Max of 8.GB
                time = { 8.h * task.attempt }    // Max of 16.h
            }
        }
    }

    // Profile for Somatic Variant Analysis step of pipeline using Slurm executor
    somatic {

        singularity.enabled = true
        singularity.autoMounts = true

        // Set the Singularity module if one was provided as input parameter
        if( params.singularity_module ) {
            process.module = "${params.singularity_module}"
        }

        process.executor = 'slurm'
    }


    // Profiles for local testing of pipeline steps in development environment using Docker, likely will require
    // configuration of the daemon's resources. This can be done within the 'Preferences' > 'Resources' tab of the 
    // Docker Desktop Dashboard for macOS
    
    // Preprocessing Dev Profile
    dev_preprocessing {

        docker.enabled = true

        process {

            withName: revertMappedBam_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: bamToFastq_biobambam {
                container = "patrickblaneynyu/mgp1000:biobambam-2.0.87"
            }
            withName: fastqTrimming_trimmomatic {
                container = "patrickblaneynyu/mgp1000:trimmomatic-0.36"
                cpus = 4
                memory = 12.GB
            }
            withName: fastqQualityControlMetrics_fastqc {
                container = "patrickblaneynyu/mgp1000:fastqc-0.11.9"
            }
            withName: alignment_bwa {
                container = "patrickblaneynyu/mgp1000:bwa-0.7.17-sambamba-0.7.1"
                cpus = 4
                memory = 12.GB
            }
            withName: fixMateInformationAndSort_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: markDuplicatesAndIndex_sambamba {
                container = "patrickblaneynyu/mgp1000:sambamba-0.7.1"
                cpus = 2
            }
            withName: downsampleBam_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: baseRecalibrator_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: applyBqsr_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 10.GB
            }
            withName: collectWgsMetrics_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: collectGcBiasMetrics_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: extremeBamQualityControl_qualimap {
                container = "patrickblaneynyu/mgp1000:qualimap-2.2.1"
                cpus = 2
                memory = 12.GB
            }
        }
    }

    // Germline Variant Analysis Dev Profile
    dev_germline {

        docker.enabled = true

        process {

            withName: telomereLengthEstimation_telseq {
                container = "patrickblaneynyu/mgp1000:telseq-0.0.1"
                memory = 1.GB
            }
            withName: splitIntervalList_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 4.GB
            }
            withName: haplotypeCaller_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 6.GB
                cpus = 2
            }
            withName: mergeAndSortGvcfs_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: combineAllGvcfs_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: jointGenotyping_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
                cpus = 2
            }
            withName: excessHeterozygosityHardFilter_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 8.GB
            }
            withName: indelVariantRecalibration_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: snpVariantRecalibration_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: applyIndelAndSnpVqsr_gatk {
                container = "patrickblaneynyu/mgp1000:gatk-4.1.7.0"
                memory = 12.GB
            }
            withName: splitMultiallelicAndLeftNormalizeVcf_bcftools {
                container = "patrickblaneynyu/mgp1000:bcftools-1.10.2"
                memory = 12.GB
                cpus = 2
            }
            withName: downloadVepAnnotationReferences_vep {
                container = "patrickblaneynyu/mgp1000:vep-101.0"
                memory = 12.GB
                cpus = 1
            }
            withName: annotateGermlineVcf_vep {
                container = "patrickblaneynyu/mgp1000:vep-101.0"
                memory = 12.GB
                cpus = 1
            }
            withName: referenceVcfPrep_bcftools {
                container = "patrickblaneynyu/mgp1000:bcftools-1.10.2"
                memory = 12.GB
                cpus = 2
            }
            withName: mergeCohortAndReferenceVcf_bcftools {
                container = "patrickblaneynyu/mgp1000:bcftools-1.10.2"
                memory = 12.GB
                cpus = 2
            }
            withName: hardFilterCohortReferenceMergedVcf_vcftools {
                container = "patrickblaneynyu/mgp1000:vcftools-0.1.16"
                memory = 12.GB
            }
            withName: filterPlinkFilesForAdmixture_plink {
                container = "patrickblaneynyu/mgp1000:plink-1.90"
                memory = 12.GB
                cpus = 2
            }
            withName: ancestryEstimation_admixture {
                container = "patrickblaneynyu/mgp1000:admixture-1.3.0"
                memory = 12.GB
                cpus = 2
            }
        }
    }

    // Somatic Variant Analysis Dev Profile
    dev_somatic {

        docker.enabled = true


    }
}